package com.ijoomer.components.jomsocial;

import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;

import android.app.Activity;
import android.content.Intent;
import android.media.MediaScannerConnection;
import android.media.MediaScannerConnection.OnScanCompletedListener;
import android.net.Uri;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentStatePagerAdapter;
import android.support.v4.view.ViewPager;
import android.support.v4.view.ViewPager.OnPageChangeListener;
import android.text.Html;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.AbsListView;
import android.widget.AbsListView.OnScrollListener;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.RadioGroup;
import android.widget.SeekBar;

import com.androidquery.AQuery;
import com.androidquery.callback.AjaxCallback;
import com.androidquery.callback.AjaxStatus;
import com.ijoomer.common.classes.IJoomerTwitterShareActivity;
import com.ijoomer.common.classes.IjoomerFileChooserActivity;
import com.ijoomer.common.classes.IjoomerUtilities;
import com.ijoomer.common.classes.ViewHolder;
import com.ijoomer.common.configuration.IjoomerApplicationConfiguration;
import com.ijoomer.custom.interfaces.CustomClickListner;
import com.ijoomer.custom.interfaces.ReportListner;
import com.ijoomer.custom.interfaces.ShareListner;
import com.ijoomer.customviews.IjoomerButton;
import com.ijoomer.customviews.IjoomerEditText;
import com.ijoomer.customviews.IjoomerTextView;
import com.ijoomer.library.jomsocial.JomGalleryDataProvider;
import com.ijoomer.src.R;
import com.ijoomer.weservice.WebCallListener;
import com.smart.framework.CustomAlertMagnatic;
import com.smart.framework.CustomAlertNeutral;
import com.smart.framework.ItemView;
import com.smart.framework.SmartListAdapterWithHolder;
import com.smart.framework.SmartListItem;

public class JomPhotoDetailsActivity extends JomMasterActivity {

	private LinearLayout listFooter;
	private ListView lstPhotoComment;
	private LinearLayout lnrPhotoHeader;
	private IjoomerTextView txtPhotoAsCoverPage;
	private IjoomerTextView txtPhotAsProfilePicture;
	private IjoomerTextView txtPhotoCaption;
	private IjoomerTextView txtPhotoRemove;
	private IjoomerTextView txtPhotoDownload;
	private IjoomerTextView txtPhotoShare;
	private IjoomerTextView txtPhotoReport;
	private IjoomerTextView txtPhotoLikeCount;
	private IjoomerTextView txtPhotoDislikeCount;
	private IjoomerTextView txtPhotoCommentCount;
	private IjoomerTextView txtPhotoTagCount;
	private IjoomerTextView txtPhotoCurrentView;
	private IjoomerEditText edtPhotoWriteComment;
	private IjoomerEditText edtPhotoCaption;
	private IjoomerButton btnPhotoCaptionEdit;
	private IjoomerButton btnSend;
	private ProgressBar pbrPhotoViewPager;
	private ViewPager viewPager;
	private ViewGroup photoDeatilHeaderLayout;

	private AQuery androidQuery;
	private ArrayList<HashMap<String, String>> IN_PHOTO_LIST;
	private HashMap<Integer, ArrayList<HashMap<String, String>>> commentListStack = new HashMap<Integer, ArrayList<HashMap<String, String>>>();
	private HashMap<String, String> IN_ALBUM;
	private ArrayList<SmartListItem> listData = new ArrayList<SmartListItem>();
	private SmartListAdapterWithHolder commentAdapter;
	private PageAdapter adapter;

	private JomGalleryDataProvider commentProvider;
	private JomGalleryDataProvider provider;

	final private int FILE_LOCATION = 5;
	public static int IN_TOTAL_COUNT;
	public static boolean isSetCoverChanged;
	private String IN_USERID;
	private int IN_SELECTED_INDEX;
	private boolean isAddComment = false;

	/**
	 * Overrides method
	 */

	@Override
	public int setLayoutId() {
		return R.layout.jom_photo_details;
	}

	@Override
	public void initComponents() {

		photoDeatilHeaderLayout = (ViewGroup) LayoutInflater.from(this).inflate(R.layout.jom_photo_details_header, null);
		listFooter = (LinearLayout) LayoutInflater.from(this).inflate(R.layout.ijoomer_list_footer, null);
		lstPhotoComment = (ListView) findViewById(R.id.lstPhotoComment);
		lstPhotoComment.addHeaderView(photoDeatilHeaderLayout, null, false);
		lstPhotoComment.addFooterView(listFooter, null, false);
		lstPhotoComment.setAdapter(null);
		lnrPhotoHeader = (LinearLayout) findViewById(R.id.lnrPhotoHeader);
		txtPhotoRemove = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoRemove);
		txtPhotoDownload = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoDownload);
		txtPhotoReport = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoReport);
		txtPhotoShare = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoShare);
		txtPhotoLikeCount = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoLikeCount);
		txtPhotoDislikeCount = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoDislikeCount);
		txtPhotoCommentCount = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoCommentCount);
		txtPhotoTagCount = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoTagCount);
		txtPhotoCaption = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoCaption);
		txtPhotoAsCoverPage = (IjoomerTextView) findViewById(R.id.txtPhotoAsCoverPage);
		txtPhotAsProfilePicture = (IjoomerTextView) findViewById(R.id.txtPhotAsProfilePicture);
		txtPhotoCurrentView = (IjoomerTextView) photoDeatilHeaderLayout.findViewById(R.id.txtPhotoCurrentView);
		edtPhotoCaption = (IjoomerEditText) photoDeatilHeaderLayout.findViewById(R.id.edtPhotoCaption);
		edtPhotoWriteComment = (IjoomerEditText) photoDeatilHeaderLayout.findViewById(R.id.edtPhotoWriteComment);
		btnPhotoCaptionEdit = (IjoomerButton) photoDeatilHeaderLayout.findViewById(R.id.btnPhotoCaptionEdit);
		btnSend = (IjoomerButton) photoDeatilHeaderLayout.findViewById(R.id.btnSend);
		pbrPhotoViewPager = (ProgressBar) photoDeatilHeaderLayout.findViewById(R.id.pbrPhotoViewPager);
		viewPager = (ViewPager) photoDeatilHeaderLayout.findViewById(R.id.viewPager);

		androidQuery = new AQuery(this);
		commentProvider = new JomGalleryDataProvider(this);
		provider = new JomGalleryDataProvider(JomPhotoDetailsActivity.this);
		IN_TOTAL_COUNT = 0;
		isSetCoverChanged = false;

		getIntentData();
	}

	@Override
	public void prepareViews() {
		if (IN_TOTAL_COUNT != IN_PHOTO_LIST.size() && (IN_PHOTO_LIST.size() - IN_SELECTED_INDEX) <= 2) {
			provider.restorePagingSettings();
			provider.setPageNo(getPageNoCall());
			provider.setPageLimit(12);
			pbrPhotoViewPager.setVisibility(View.VISIBLE);
			provider.getPhotoList(IN_ALBUM.get(ID), IN_USERID, new WebCallListener() {

				@Override
				public void onProgressUpdate(int progressCount) {

				}

				@Override
				public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
					if (responseCode == 200) {
						IN_PHOTO_LIST.addAll(data1);
						adapter = new PageAdapter(getSupportFragmentManager());
						viewPager.setAdapter(adapter);
						viewPager.setCurrentItem(IN_SELECTED_INDEX, true);
						pbrPhotoViewPager.setVisibility(View.GONE);
						updateHeader(provider.getNotificationData());
					} else {
						responseErrorMessageHandler(responseCode, false);
					}
				}
			});
		} else {
			adapter = new PageAdapter(getSupportFragmentManager());
			viewPager.setAdapter(adapter);
			viewPager.setCurrentItem(IN_SELECTED_INDEX, true);
		}

	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		if (resultCode == Activity.RESULT_OK) {
			if (requestCode == FILE_LOCATION) {
				final String path = data.getStringExtra("IN_PATH");
				final String fileName = IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(URL).split("/")[IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(URL).split("/").length - 1];
				androidQuery.download(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(URL), new File(path + fileName), new AjaxCallback<File>() {
					@Override
					public void callback(String url, File object, AjaxStatus status) {
						super.callback(url, object, status);
						if (status.getCode() == 200) {
							IjoomerUtilities.getCustomOkDialog(getString(R.string.download), getString(R.string.alert_message_file_downloaded), getString(R.string.ok),
									R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

										@Override
										public void NeutralMathod() {
											MediaScannerConnection.scanFile(JomPhotoDetailsActivity.this, new String[] { path + fileName }, null, new OnScanCompletedListener() {

												@Override
												public void onScanCompleted(String path, Uri uri) {

												}
											});
										}
									});
						} else {
							IjoomerUtilities.getCustomOkDialog(getString(R.string.download), status.getMessage(), getString(R.string.ok), R.layout.ijoomer_ok_dialog,
									new CustomAlertNeutral() {

										@Override
										public void NeutralMathod() {

										}
									});
						}
					}
				});
			}
		}
	}

	@Override
	public void setActionListeners() {

		btnPhotoCaptionEdit.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				if (btnPhotoCaptionEdit.getText().toString().equals(getString(R.string.edit))) {
					edtPhotoCaption.setText(txtPhotoCaption.getText().toString());
					txtPhotoCaption.setVisibility(View.GONE);
					edtPhotoCaption.setVisibility(View.VISIBLE);
					btnPhotoCaptionEdit.setText(getString(R.string.save));
				} else {
					if (edtPhotoCaption.getText().toString().trim().length() > 0
							&& (!edtPhotoCaption.getText().toString().trim().equals(txtPhotoCaption.getText().toString().trim()))) {
						provider.setPhotoCaption(IN_PHOTO_LIST.get(viewPager.getCurrentItem()).get(ID), edtPhotoCaption.getText().toString(), new WebCallListener() {
							final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

							@Override
							public void onProgressUpdate(int progressCount) {
								proSeekBar.setProgress(progressCount);
							}

							@Override
							public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
								btnPhotoCaptionEdit.setText(getString(R.string.edit));
								txtPhotoCaption.setVisibility(View.VISIBLE);
								edtPhotoCaption.setVisibility(View.GONE);

								if (responseCode == 200) {
									updateHeader(provider.getNotificationData());
									txtPhotoCaption.setText(edtPhotoCaption.getText().toString());
									IjoomerApplicationConfiguration.setReloadRequired(true);
									IN_PHOTO_LIST.get(viewPager.getCurrentItem()).put(CAPTION, edtPhotoCaption.getText().toString());

								} else {
									responseErrorMessageHandler(responseCode, false);
								}
							}
						});

					} else {
						btnPhotoCaptionEdit.setText(getString(R.string.edit));
						txtPhotoCaption.setVisibility(View.VISIBLE);
						edtPhotoCaption.setVisibility(View.GONE);
					}
				}
			}
		});

		lstPhotoComment.setOnScrollListener(new OnScrollListener() {

			@Override
			public void onScrollStateChanged(AbsListView view, int scrollState) {

			}

			@Override
			public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {
				if ((firstVisibleItem + visibleItemCount) >= totalItemCount && totalItemCount > 2) {
					if (!commentProvider.isCalling() && commentProvider.hasNextPage()) {
						listFooterVisible();
						commentProvider.getPhotoCommentList(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

							@Override
							public void onProgressUpdate(int progressCount) {

							}

							@Override
							public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
								listFooterInvisible();
								if (responseCode == 200) {
									updateHeader(commentProvider.getNotificationData());
									prepareList(data1, true);
								} else {
									responseErrorMessageHandler(responseCode, false);
								}
							}
						});
					}
				}
			}
		});

		txtPhotAsProfilePicture.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {

				provider.setAsProfileAvatar(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {
					final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

					@Override
					public void onProgressUpdate(int progressCount) {
						proSeekBar.setProgress(progressCount);
					}

					@Override
					public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
						if (responseCode == 200) {
							updateHeader(provider.getNotificationData());
							IjoomerUtilities.getCustomOkDialog(getString(R.string.photo), getString(R.string.photo_set_as_profile_avatar_successfully), getString(R.string.ok),
									R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

										@Override
										public void NeutralMathod() {

										}
									});

						} else {
							responseErrorMessageHandler(responseCode, false);
						}
					}
				});

			}
		});

		txtPhotoAsCoverPage.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {

				provider.setAsCoverPage(IN_ALBUM.get(ID), IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {
					final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

					@Override
					public void onProgressUpdate(int progressCount) {
						proSeekBar.setProgress(progressCount);
					}

					@Override
					public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
						if (responseCode == 200) {
							updateHeader(provider.getNotificationData());
							isSetCoverChanged = true;
							IjoomerApplicationConfiguration.setReloadRequired(true);
							IjoomerUtilities.getCustomOkDialog(getString(R.string.photo), getString(R.string.photo_set_as_cover_page_successfully), getString(R.string.ok),
									R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

										@Override
										public void NeutralMathod() {

										}
									});

						} else {
							responseErrorMessageHandler(responseCode, false);
						}
					}
				});

			}
		});
		txtPhotoTagCount.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				try {
					loadNew(JomPhotoTagActivity.class, JomPhotoDetailsActivity.this, false, "IN_PHOTO_LIST", IN_PHOTO_LIST, "IN_SELECTED_INDEX", IN_SELECTED_INDEX,
							"IN_TOTAL_COUNT", IN_TOTAL_COUNT, "IN_ALBUM", IN_ALBUM);
				} catch (Exception e) {
				}
				// showPhotoTagOrRemoveDialog();
			}
		});

		txtPhotoRemove.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				IjoomerUtilities.getCustomConfirmDialog(getString(R.string.album_title_remove), getString(R.string.are_you_sure), getString(R.string.yes), getString(R.string.no),
						new CustomAlertMagnatic() {

							@Override
							public void PositiveMathod() {
								pbrPhotoViewPager.setVisibility(View.VISIBLE);
								provider.removePhoto(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

									@Override
									public void onProgressUpdate(int progressCount) {
									}

									@Override
									public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
										pbrPhotoViewPager.setVisibility(View.GONE);
										if (responseCode == 200) {
											updateHeader(provider.getNotificationData());
											IjoomerApplicationConfiguration.setReloadRequired(true);
											IN_TOTAL_COUNT = IN_TOTAL_COUNT - 1;
											IN_PHOTO_LIST.remove(IN_SELECTED_INDEX);
											if (IN_PHOTO_LIST.size() <= 0) {
												finish();
											} else {
												IN_SELECTED_INDEX = IN_SELECTED_INDEX - 1;
												if (IN_SELECTED_INDEX <= 0) {
													IN_SELECTED_INDEX = IN_SELECTED_INDEX + 1;
												} else {
													IN_SELECTED_INDEX = IN_SELECTED_INDEX - 1;
												}
												adapter.notifyDataSetChanged();
												viewPager.setCurrentItem(((IN_TOTAL_COUNT - 1) > IN_SELECTED_INDEX) ? IN_SELECTED_INDEX + 1 : IN_SELECTED_INDEX - 1, true);
											}
										} else {
											responseErrorMessageHandler(responseCode, false);
										}
									}
								});
							}

							@Override
							public void NegativeMathod() {

							}
						});

			}
		});
		btnSend.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				hideSoftKeyboard();
				if (edtPhotoWriteComment.getText().toString().trim().length() > 0) {
					provider.addPhotoComment(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), edtPhotoWriteComment.getText().toString().trim(), new WebCallListener() {
						final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

						@Override
						public void onProgressUpdate(int progressCount) {
							proSeekBar.setProgress(progressCount);
						}

						@Override
						public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
							if (responseCode == 200) {
								updateHeader(provider.getNotificationData());
								IjoomerApplicationConfiguration.setReloadRequired(true);
								isAddComment = true;
								edtPhotoWriteComment.setText(null);
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX)
										.put(COMMENTCOUNT, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(COMMENTCOUNT)) + 1));
								txtPhotoCommentCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(COMMENTCOUNT));
								getComment();
							} else {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					});
				} else {
					edtPhotoWriteComment.setError(getString(R.string.validation_value_required));
				}
			}
		});

		viewPager.setOnPageChangeListener(new OnPageChangeListener() {

			@Override
			public void onPageSelected(int pos) {
				IN_SELECTED_INDEX = pos;
				setPhotoDetail(IN_SELECTED_INDEX);

				if (IN_PHOTO_LIST.size() < IN_TOTAL_COUNT) {
					loadPhotoList();
				}

				getComment();
			}

			@Override
			public void onPageScrolled(int arg0, float arg1, int arg2) {

			}

			@Override
			public void onPageScrollStateChanged(int arg0) {

			}
		});

		txtPhotoShare.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {

				IjoomerUtilities.getShareDialog(new ShareListner() {
					@Override
					public void onClick(String shareOn, Object value, String message) {
						if (shareOn.equals("email")) {
							String[] to = value.toString().split(",");
							Intent i = new Intent(Intent.ACTION_SEND);
							i.setType("text/html");
							i.putExtra(Intent.EXTRA_EMAIL, to);
							i.putExtra(Intent.EXTRA_SUBJECT, getString(R.string.share_email_subject));
							i.putExtra(Intent.EXTRA_TEXT, Html.fromHtml(IjoomerUtilities.prepareEmailBody(message == null ? "" : message, getSmartApplication()
									.readSharedPreferences().getString(SP_USERNAME, "")
									+ " "
									+ getString(R.string.saw_this_story_on_the)
									+ " "
									+ getString(R.string.app_name)
									+ " " + getString(R.string.thought_you_should_see_it), IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(CAPTION), IN_PHOTO_LIST.get(IN_SELECTED_INDEX)
									.get(SHARELINK), getString(R.string.try_ijoomeradvance))));
							try {
								startActivity(Intent.createChooser(i, "Send mail..."));
							} catch (android.content.ActivityNotFoundException ex) {
								ting(getString(R.string.share_email_no_client));
							}
						} else if (shareOn.equals("facebook")) {
							facebookSharing(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(CAPTION), IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(CAPTION),
									IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(CAPTION), IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(SHARELINK), IN_PHOTO_LIST.get(IN_SELECTED_INDEX)
											.get(URL), message == null ? "" : message);
						} else if (shareOn.equals("twitter")) {
							try {
								loadNew(IJoomerTwitterShareActivity.class, JomPhotoDetailsActivity.this, false, "IN_TWIT_MESSAGE", message == null ? "" : message + " \n "
										+ IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(SHARELINK), "IN_TWIT_IMAGE", IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(URL));
							} catch (Throwable e) {
								e.printStackTrace();
							}
						}
					}
				});

			}
		});
		txtPhotoDownload.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				Intent intent = new Intent(JomPhotoDetailsActivity.this, IjoomerFileChooserActivity.class);
				startActivityForResult(intent, FILE_LOCATION);
			}
		});

		txtPhotoLikeCount.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				if (IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKED).equals("1")) {
					provider.unlikePhoto(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

						@Override
						public void onProgressUpdate(int progressCount) {

						}

						@Override
						public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
							if (responseCode == 200) {
								updateHeader(provider.getNotificationData());
								IjoomerApplicationConfiguration.setReloadRequired(true);
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKED, "0");
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES)) - 1));
								txtPhotoLikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES));
							} else {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					});
				} else {
					provider.likePhoto(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

						@Override
						public void onProgressUpdate(int progressCount) {

						}

						@Override
						public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
							if (responseCode == 200) {
								updateHeader(provider.getNotificationData());
								IjoomerApplicationConfiguration.setReloadRequired(true);
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKED, "1");
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES)) + 1));
								txtPhotoLikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES));
								if (IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKED).equals("1")) {
									IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES)) - 1));
									IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKED, "0");
									txtPhotoDislikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES));
								}
							} else {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					});
				}
			}
		});

		txtPhotoDislikeCount.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				if (IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKED).equals("1")) {
					provider.unlikePhoto(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

						@Override
						public void onProgressUpdate(int progressCount) {

						}

						@Override
						public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
							if (responseCode == 200) {
								updateHeader(provider.getNotificationData());
								IjoomerApplicationConfiguration.setReloadRequired(true);
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKED, "0");
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES)) - 1));
								txtPhotoDislikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES));
							} else {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					});
				} else {
					provider.dislikePhoto(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

						@Override
						public void onProgressUpdate(int progressCount) {

						}

						@Override
						public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
							if (responseCode == 200) {
								updateHeader(provider.getNotificationData());
								IjoomerApplicationConfiguration.setReloadRequired(true);
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKED, "1");
								IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(DISLIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES)) + 1));
								txtPhotoDislikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(DISLIKES));
								if (IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKED).equals("1")) {
									IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKES, String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES)) - 1));
									IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(LIKED, "0");
									txtPhotoLikeCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(LIKES));
								}
							} else {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					});
				}
			}
		});

		txtPhotoReport.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				IjoomerUtilities.getReportDialog(new ReportListner() {

					@Override
					public void onClick(String repotType, String message) {
						final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));
						provider.reportPhoto(IN_USERID, IN_ALBUM.get(ID), IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), repotType + "  " + message, new WebCallListener() {

							@Override
							public void onProgressUpdate(int progressCount) {
								proSeekBar.setProgress(progressCount);
							}

							@Override
							public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
								if (responseCode == 200) {
									updateHeader(provider.getNotificationData());
									IjoomerUtilities.getCustomOkDialog(getString(R.string.photo), getString(R.string.report_successfully), getString(R.string.ok),
											R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

												@Override
												public void NeutralMathod() {

												}
											});
								} else {
									responseErrorMessageHandler(responseCode, false);
								}
							}
						});
					}
				});
			}
		});
	}

	@Override
	public void onCheckedChanged(RadioGroup arg0, int arg1) {
	}

	/**
	 * Class method
	 */

	@SuppressWarnings("unchecked")
	private void getIntentData() {
		IN_PHOTO_LIST = (ArrayList<HashMap<String, String>>) getIntent().getSerializableExtra("IN_PHOTO_LIST") == null ? new ArrayList<HashMap<String, String>>()
				: (ArrayList<HashMap<String, String>>) getIntent().getSerializableExtra("IN_PHOTO_LIST");
		IN_ALBUM = (HashMap<String, String>) getIntent().getSerializableExtra("IN_ALBUM") == null ? new HashMap<String, String>() : (HashMap<String, String>) getIntent()
				.getSerializableExtra("IN_ALBUM");
		IN_USERID = getIntent().getStringExtra("IN_USERID") == null ? "0" : getIntent().getStringExtra("IN_USERID");
		IN_SELECTED_INDEX = getIntent().getIntExtra("IN_SELECTED_INDEX", 0);
		IN_TOTAL_COUNT = getIntent().getIntExtra("IN_TOTAL_COUNT", 0);

		if (IN_ALBUM.get(DELETEALLOWED).equals("1")) {
			lnrPhotoHeader.setVisibility(View.VISIBLE);
			txtPhotoRemove.setVisibility(View.VISIBLE);
			txtPhotAsProfilePicture.setVisibility(View.GONE);
		}
		if (IN_ALBUM.get(DELETEALLOWED).equals("1") && IN_ALBUM.get(USER_ID).equals("0")) {
			lnrPhotoHeader.setVisibility(View.VISIBLE);
			txtPhotoRemove.setVisibility(View.VISIBLE);
			txtPhotAsProfilePicture.setVisibility(View.VISIBLE);
			btnPhotoCaptionEdit.setVisibility(View.VISIBLE);
		}
		if (IN_ALBUM.containsKey(EDITALBUM) && IN_ALBUM.get(EDITALBUM).equals("1") && IN_ALBUM.get(USER_ID).equals("0")) {
			lnrPhotoHeader.setVisibility(View.VISIBLE);
			txtPhotoRemove.setVisibility(View.VISIBLE);
			txtPhotAsProfilePicture.setVisibility(View.VISIBLE);
		} else if (IN_ALBUM.containsKey(EDITALBUM) && IN_ALBUM.get(EDITALBUM).equals("1")) {
			lnrPhotoHeader.setVisibility(View.VISIBLE);
			txtPhotoRemove.setVisibility(View.VISIBLE);
			txtPhotAsProfilePicture.setVisibility(View.GONE);
		}

		setPhotoDetail(IN_SELECTED_INDEX);
		getComment();

	}

	private void responseErrorMessageHandler(final int responseCode, final boolean finishActivityOnConnectionProblem) {
		IjoomerUtilities.getCustomOkDialog(getString(R.string.photo), getString(getResources().getIdentifier("code" + responseCode, "string", getPackageName())),
				getString(R.string.ok), R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

					@Override
					public void NeutralMathod() {
						if (responseCode == 599 && finishActivityOnConnectionProblem) {
							finish();
						}
					}
				});
	}

	private void getComment() {

		if (!IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(COMMENTCOUNT).equals("0")) {

			if (commentListStack.containsKey(IN_SELECTED_INDEX) && commentListStack.get(IN_SELECTED_INDEX).size() > 0 && !isAddComment) {
				prepareList(commentListStack.get(IN_SELECTED_INDEX), false);
				commentAdapter = getListAdapter();
				lstPhotoComment.setAdapter(commentAdapter);
			} else {
				commentProvider.restorePagingSettings();
				commentProvider.getPhotoCommentList(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(ID), new WebCallListener() {

					@Override
					public void onProgressUpdate(int progressCount) {

					}

					@Override
					public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
						if (responseCode == 200) {
							updateHeader(commentProvider.getNotificationData());
							commentListStack.put(IN_SELECTED_INDEX, data1);
							prepareList(data1, false);
							commentAdapter = getListAdapter();
							lstPhotoComment.setAdapter(commentAdapter);
						} else {
							if (responseCode != 204) {
								responseErrorMessageHandler(responseCode, false);
							}
						}
					}
				});
			}

		} else {
			lstPhotoComment.setAdapter(null);
		}
	}

	private void setPhotoDetail(int index) {
		txtPhotoLikeCount.setText(IN_PHOTO_LIST.get(index).get(LIKES));
		txtPhotoDislikeCount.setText(IN_PHOTO_LIST.get(index).get(DISLIKES));
		txtPhotoCommentCount.setText(IN_PHOTO_LIST.get(index).get(COMMENTCOUNT));
		txtPhotoTagCount.setText(IN_PHOTO_LIST.get(index).get(TAGS));
		txtPhotoCurrentView.setText(index + 1 + " " + getString(R.string.photo_of) + " " + IN_TOTAL_COUNT);
		if (IN_PHOTO_LIST.get(index).containsKey(USER_ID) && IN_PHOTO_LIST.get(index).get(USER_ID).equals("0")) {
			txtPhotAsProfilePicture.setClickable(true);
			txtPhotoAsCoverPage.setClickable(true);
			txtPhotoRemove.setClickable(true);
		}
		txtPhotoCaption.setText(IN_PHOTO_LIST.get(index).get(CAPTION));
	}

	public int getPageNoCall() {
		if (IN_TOTAL_COUNT > IN_PHOTO_LIST.size()) {
			return IN_PHOTO_LIST.size() / (12 + 1);
		}
		return 0;
	}

	public void listFooterVisible() {
		listFooter.setVisibility(View.VISIBLE);
	}

	public void listFooterInvisible() {
		listFooter.setVisibility(View.GONE);
	}

	private void loadPhotoList() {
		if (!provider.isCalling()) {
			provider.restorePagingSettings();
			provider.setPageNo(getPageNoCall());
			provider.setPageLimit(12);
			provider.getPhotoList(IN_ALBUM.get(ID), IN_USERID, new WebCallListener() {

				@Override
				public void onProgressUpdate(int progressCount) {

				}

				@SuppressWarnings({ "rawtypes", "unchecked" })
				@Override
				public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
					if (responseCode == 200) {
						updateHeader(provider.getNotificationData());
						HashSet set = new HashSet();
						set.addAll(IN_PHOTO_LIST);
						set.addAll(data1);
						IN_PHOTO_LIST.clear();
						IN_PHOTO_LIST.addAll(set);
					} else {
						responseErrorMessageHandler(responseCode, false);
					}
				}
			});
		}
	}

	public ArrayList<SmartListItem> prepareList(ArrayList<HashMap<String, String>> data, boolean append) {
		if (data != null) {
			if (!append) {
				listData.clear();
			}
			for (HashMap<String, String> hashMap : data) {
				SmartListItem item = new SmartListItem();
				item.setItemLayout(R.layout.jom_comment_list_item);
				ArrayList<Object> obj = new ArrayList<Object>();
				obj.add(hashMap);
				item.setValues(obj);
				if (append) {
					commentAdapter.add(item);
				} else {
					listData.add(item);
				}
			}

		}

		return listData;
	}

	/**
	 * List adapter
	 */

	private SmartListAdapterWithHolder getListAdapter() {
		SmartListAdapterWithHolder adapterWithHolder = new SmartListAdapterWithHolder(JomPhotoDetailsActivity.this, R.layout.jom_comment_list_item, listData, new ItemView() {
			@Override
			public View setItemView(final int position, View v, SmartListItem item, ViewHolder holder) {
				holder.imgCommentUserAvatar = (ImageView) v.findViewById(R.id.imgCommentUserAvatar);
				holder.txtCommentUserName = (IjoomerTextView) v.findViewById(R.id.txtCommentUserName);
				holder.txtCommentDate = (IjoomerTextView) v.findViewById(R.id.txtCommentDate);
				holder.txtCommentTitle = (IjoomerTextView) v.findViewById(R.id.txtCommentTitle);
				holder.btnCommentRemove = (IjoomerButton) v.findViewById(R.id.btnCommentRemove);
				holder.btnCommentRemove.setVisibility(View.GONE);
				@SuppressWarnings("unchecked")
				final HashMap<String, String> row = (HashMap<String, String>) item.getValues().get(0);

				androidQuery.id(holder.imgCommentUserAvatar).image(row.get(USER_AVATAR), true, true, getDeviceWidth(), 0);
				holder.txtCommentTitle.setText(row.get(COMMENT));
				holder.txtCommentUserName.setText(row.get(USER_NAME));
				holder.txtCommentDate.setText(row.get(DATE));
				if (row.containsKey(DELETEALLOWED) && row.get(DELETEALLOWED).equals("1")) {
					holder.btnCommentRemove.setVisibility(View.VISIBLE);
				}

				holder.btnCommentRemove.setOnClickListener(new OnClickListener() {

					@Override
					public void onClick(View arg0) {

						IjoomerUtilities.getCustomConfirmDialog(getString(R.string.video), getString(R.string.are_you_sure), getString(R.string.yes), getString(R.string.no),
								new CustomAlertMagnatic() {

									@Override
									public void PositiveMathod() {
										provider.removePhotoComment(row.get(ID), new WebCallListener() {
											final SeekBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

											@Override
											public void onProgressUpdate(int progressCount) {
												proSeekBar.setProgress(progressCount);
											}

											@Override
											public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
												if (responseCode == 200) {
													updateHeader(provider.getNotificationData());
													commentAdapter.remove(commentAdapter.getItem(position));
													IN_PHOTO_LIST.get(IN_SELECTED_INDEX).put(COMMENTCOUNT,
															String.valueOf(Integer.parseInt(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(COMMENTCOUNT)) - 1));
													txtPhotoCommentCount.setText(IN_PHOTO_LIST.get(IN_SELECTED_INDEX).get(COMMENTCOUNT));
												} else {
													responseErrorMessageHandler(responseCode, false);
												}

											}
										});
									}

									@Override
									public void NegativeMathod() {

									}
								});

					}
				});

				holder.imgCommentUserAvatar.setOnClickListener(new OnClickListener() {

					@Override
					public void onClick(View arg0) {

						if (row.get(USER_PROFILE).equals("1")) {
							gotoProfile(row.get(USER_ID));
						}
					}
				});

				return v;
			}

			@Override
			public View setItemView(int position, View v, SmartListItem item) {
				return null;
			}
		});
		return adapterWithHolder;
	}

	/**
	 * Custom Class
	 */

	private class PageAdapter extends FragmentStatePagerAdapter {

		public PageAdapter(FragmentManager fm) {
			super(fm);
		}

		public int getItemPosition(Object object) {
			return POSITION_NONE;
		}

		@Override
		public Fragment getItem(int pos) {
			JomPhotoDetailFragment fragment = new JomPhotoDetailFragment(IN_PHOTO_LIST.get(pos).get(URL), new CustomClickListner() {

				@Override
				public void onClick(String value) {
					try {
						loadNew(JomPhotoTagActivity.class, JomPhotoDetailsActivity.this, false, "IN_PHOTO_LIST", IN_PHOTO_LIST, "IN_SELECTED_INDEX", IN_SELECTED_INDEX,
								"IN_TOTAL_COUNT", IN_TOTAL_COUNT, "IN_ALBUM", IN_ALBUM);
					} catch (Exception e) {
						e.printStackTrace();
					}
				}
			});
			return fragment;
		}

		@Override
		public int getCount() {
			return IN_TOTAL_COUNT;
		}

	}

}
