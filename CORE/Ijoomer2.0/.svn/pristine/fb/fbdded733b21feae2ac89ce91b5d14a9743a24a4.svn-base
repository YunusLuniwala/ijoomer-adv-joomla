package com.ijoomer.components.jomsocial;

import java.util.ArrayList;
import java.util.HashMap;

import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.GridView;
import android.widget.ImageView;
import android.widget.ProgressBar;

import com.androidquery.AQuery;
import com.ijoomer.common.classes.IjoomerUtilities;
import com.ijoomer.common.classes.ViewHolder;
import com.ijoomer.library.jomsocial.JomGalleryDataProvider;
import com.ijoomer.src.R;
import com.ijoomer.weservice.WebCallListener;
import com.smart.framework.CustomAlertMagnatic;
import com.smart.framework.CustomAlertNeutral;
import com.smart.framework.ItemView;
import com.smart.framework.SmartActivity;
import com.smart.framework.SmartListAdapterWithHolder;
import com.smart.framework.SmartListItem;

public class JomPhotoFragment extends Fragment {

	private GridView grdPhoto;
	private ProgressBar pbrPhotoGrid;
	private View v;

	private AQuery androidQuery;
	private ArrayList<HashMap<String, String>> photoData;
	private ArrayList<SmartListItem> photoList;
	private HashMap<String, String> IN_ALBUM;
	private SmartListAdapterWithHolder gridAdapter;

	private JomGalleryDataProvider photoProvider;

	private String IN_PROFILE_COVER;
	private String userID;
	private int pageNo;
	private boolean isInitial = false;

	public JomPhotoFragment(int pageNo, HashMap<String, String> IN_ALBUM, String userID, String profileCover) {
		this.IN_ALBUM = IN_ALBUM;
		this.pageNo = pageNo;
		this.userID = userID;
		this.IN_PROFILE_COVER = profileCover;
	}

	/**
	 * Overrides method
	 */

	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
		v = inflater.inflate(R.layout.jom_photo_gridview, null);
		if (isInitial) {
			initComponents();
		}
		return v;
	}

	public void initComponents() {

		grdPhoto = (GridView) v.findViewById(R.id.grdPhoto);

		pbrPhotoGrid = (ProgressBar) v.findViewById(R.id.pbrPhotoGrid);
		if (photoList == null || photoList.size() <= 0) {
			photoProvider = new JomGalleryDataProvider(getActivity());
			photoProvider.restorePagingSettings();
			photoProvider.setPageNo(pageNo);
			photoProvider.setPageLimit(12);
			androidQuery = new AQuery(getActivity());
			photoList = new ArrayList<SmartListItem>();
			photoProvider.getPhotoList(IN_ALBUM.get("id"), userID, new WebCallListener() {

				@Override
				public void onProgressUpdate(int progressCount) {
				}

				@Override
				public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
					pbrPhotoGrid.setVisibility(View.GONE);
					if (responseCode == 200) {
						setPhotoData(data1);
						prepareGrid(data1);
						gridAdapter = getPhotoAdapter();
						grdPhoto.setAdapter(gridAdapter);
						gridAdapter.notifyDataSetChanged();
						grdPhoto.setOnItemClickListener(new OnItemClickListener() {

							@Override
							public void onItemClick(AdapterView<?> arg0, View arg1, int arg2, long arg3) {

							}
						});
					} else {
						IjoomerUtilities.getCustomOkDialog(getString(R.string.photo),
								getString(getResources().getIdentifier("code" + responseCode, "string", getActivity().getPackageName())), getString(R.string.ok),
								R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

									@Override
									public void NeutralMathod() {

									}
								});
					}
				}
			});
		} else {
			pbrPhotoGrid.setVisibility(View.GONE);
			gridAdapter = getPhotoAdapter();
			grdPhoto.setAdapter(gridAdapter);
			gridAdapter.notifyDataSetChanged();
		}

	}

	/**
	 * Class method
	 */
	public ArrayList<HashMap<String, String>> getPhotoData() {
		return photoData;
	}

	public void setPhotoData(ArrayList<HashMap<String, String>> photoData) {
		this.photoData = photoData;
	}

	public boolean isInitial() {
		return isInitial;
	}

	public void setInitial(boolean isInitial) {
		this.isInitial = isInitial;
	}

	private void prepareGrid(ArrayList<HashMap<String, String>> data) {
		photoList.clear();

		for (HashMap<String, String> hmData : data) {
			try {
				SmartListItem item = new SmartListItem();
				item.setItemLayout(R.layout.jom_photo_grid_item);
				ArrayList<Object> obj = new ArrayList<Object>();
				obj.add(hmData);
				item.setValues(obj);
				photoList.add(item);
			} catch (Exception e) {
			}

		}

	}

	/**
	 * List adapter
	 */

	private SmartListAdapterWithHolder getPhotoAdapter() {
		SmartListAdapterWithHolder listAdapterWithHolder = new SmartListAdapterWithHolder(getActivity(), R.layout.jom_photo_grid_item, photoList, new ItemView() {

			@Override
			public View setItemView(final int position, View v, SmartListItem item, ViewHolder holder) {
				holder.imgAlbumphoto = (ImageView) v.findViewById(R.id.imgAlbumphoto);

				@SuppressWarnings("unchecked")
				final HashMap<String, String> row = (HashMap<String, String>) item.getValues().get(0);

				try {
					androidQuery.id(holder.imgAlbumphoto).image(row.get("thumb"), true, true,((SmartActivity)getActivity()).getDeviceWidth(),0);
				} catch (Throwable e) {
					e.printStackTrace();
				}
				holder.imgAlbumphoto.setOnClickListener(new OnClickListener() {

					@Override
					public void onClick(View arg0) {
						final ArrayList<HashMap<String, String>> photoData = new ArrayList<HashMap<String, String>>();
						ArrayList<JomPhotoFragment> fragmentList = ((JomAlbumsDetailsActivity) getActivity()).getPhotoFragmetStack();
						for (JomPhotoFragment jomPhotoFragment : fragmentList) {
							if (jomPhotoFragment.getPhotoData() != null && jomPhotoFragment.getPhotoData().size() > 0) {
								photoData.addAll(jomPhotoFragment.getPhotoData());
							}
						}
						final int selectedIndex = (position + (pageNo - 1) * 12);
						if (!IN_PROFILE_COVER.equals("0")) {
							IjoomerUtilities.getCustomConfirmDialog(getString(R.string.photo), getString(R.string.are_you_sure_set_profile_cover), getString(R.string.yes),
									getString(R.string.no), new CustomAlertMagnatic() {

										@Override
										public void PositiveMathod() {
											photoProvider.setProfileCover(photoData.get(selectedIndex).get("id"), new WebCallListener() {
												final ProgressBar proSeekBar = IjoomerUtilities.getLoadingDialog(getString(R.string.dialog_loading_sending_request));

												@Override
												public void onProgressUpdate(int progressCount) {
													proSeekBar.setProgress(progressCount);
												}

												@Override
												public void onCallComplete(int responseCode, String errorMessage, ArrayList<HashMap<String, String>> data1, Object data2) {
													if (responseCode == 200) {
														IjoomerUtilities.getCustomOkDialog(getString(R.string.photo), getString(R.string.photo_set_as_profile_cover_successfully),
																getString(R.string.ok), R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

																	@Override
																	public void NeutralMathod() {

																	}
																});
													} else {
														IjoomerUtilities.getCustomOkDialog(getString(R.string.photo),
																getString(getResources().getIdentifier("code" + responseCode, "string", getActivity().getPackageName())),
																getString(R.string.ok), R.layout.ijoomer_ok_dialog, new CustomAlertNeutral() {

																	@Override
																	public void NeutralMathod() {

																	}
																});
													}
												}
											});
										}

										@Override
										public void NegativeMathod() {

										}
									});

						} else {
							try {
								((SmartActivity) getActivity()).loadNew(JomPhotoDetailsActivity.class, getActivity(), false, "IN_PHOTO_LIST", photoData, "IN_SELECTED_INDEX",
										selectedIndex, "IN_TOTAL_COUNT", photoProvider.getTotalCount(), "IN_ALBUM", IN_ALBUM);
								JomAlbumsDetailsActivity.isResume = true;
							} catch (Throwable e) {
								e.printStackTrace();
								JomAlbumsDetailsActivity.isResume = false;
							}
						}

					}
				});

				return v;

			}

			@Override
			public View setItemView(int position, View v, SmartListItem item) {
				return null;
			}

		});
		return listAdapterWithHolder;
	}

}
